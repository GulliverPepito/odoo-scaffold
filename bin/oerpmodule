#!/usr/bin/python
# PYTHON_ARGCOMPLETE_OK

import oerp_module
import argparse
import argcomplete
import os


def add_common_options(subparser):
    """
    I recive a parser object that repersent a subparser in this script to add
    it the common options needed. The subparser that share this common options
    are [create, append, branch] subparsers. The common options are:
    [module_name, module_developers, module_planners, module_auditors, dir].
    @return: the subparser object with the common arguments added.
    """
    subparser.add_argument(
        'module_name',
        metavar='MODULE_NAME',
        type=str,
        help='name of the module to create.')
    subparser.add_argument(
        '-d', '--module-developers',
        metavar='DEVELOPERS_INFO',
        type=str,
        help=str('A string with the module developers information. The format'
                 ' of this string is \'First Developer Name'
                 ' <developer@mail.com>, Second Developer Name'
                 ' <developerX@mail.com>\''),
        required=True)
    subparser.add_argument(
        '-p', '--module-planners',
        metavar='PLANNERS_INFO',
        type=str,
        help=str('A string with the module planners information. The format'
                 ' of this string is \'First Planner Name'
                 ' <planner@mail.com>, Second Planner Name'
                 ' <plannerX@mail.com>\''),
        required=True)
    subparser.add_argument(
        '-t', '--module-auditors',
        metavar='AUDITORS_INFO',
        type=str,
        help=str('A string with the module auditors information. The format'
                 ' of this string is \'First Auditor Name'
                 ' <auditor@mail.com>, Second Auditor Name'
                 ' <auditorX@mail.com>\''),
        required=True)
    subparser.add_argument(
        '-dir', '--destination-folder',
        metavar='DIR',
        type=str,
        default=os.getcwd(),
        help='name of the folder where to put the module')
    return subparser

def argument_parser(config):
    """
    This function create the help command line and manage and filter the
    parameters of this program (default values, choices values)
    """
    parser = argparse.ArgumentParser(
        prog='oerpmodule',
        description='Create new openerp module structure and basic files.',
        epilog="""
Openerp Developer Comunity Tool
Development by Vauxoo Team (lp:~vauxoo)
Coded by Katherine Zaoral <kathy@vauxoo.com>.
Source code at lp:~katherine-zaoral-7/+junk/oerp_module.""",
        formatter_class=argparse.ArgumentDefaultsHelpFormatter)
    subparsers = parser.add_subparsers(
        description=('Valid actions over a module than can be done with'
            ' oerpmodule.'),
        dest='action',
        help='subcommands help')

    # create sub parser for create action
    create_parser = subparsers.add_parser(
        'create',
        help='Inicializate module. Create new directory with basic files.')
    create_paser = add_common_options(create_parser)

    # create sub parser for branch action
    branch_parser = subparsers.add_parser(
        'branch',
        help='Create a new module using a branch.')
    branch_paser = add_common_options(branch_parser)

    branch_parser.add_argument(
        '-r', '--parent_repo',
        metavar='PARENT_REPO',
        type=str,
        required=True,
        choices=config.get_repositories_names(),
        help=('The name of repository from will be create the new module. To '
              'look the repository list use oerpmodule config -l.'))

    branch_group = branch_parser.add_argument_group('New Branch Name options', (
        'This way you can configure the new branch name.'))

    branch_group.add_argument(
        '-s', '--branch-suffix',
        metavar='DEVELOPER_ACRONYM',
        type=str,
        help=str('Generally developer acronym name. It use when creating the'
                 ' branch for identify the team user owner in a simply way,'
                 ' It use is recommended.'))
    branch_group.add_argument(
        '-ov', '--oerp-version',
        metavar='VERSION',
        type=str,
        choices=oerp_module._oerp_version_list,
        help='Openerp version number')

    branch_parser.set_defaults(
        oerp_version='7.0',
        parent_repo='addons-vauxoo')

    # create sub parser for append action
    append_parser = subparsers.add_parser(
        'append', 
        help='Append a file to the module.')
    append_paser = add_common_options(append_parser)

    append_parser.add_argument(
        '-f', '--append-file',
        metavar='TYPE',
        type=str,
        required=True,
        choices=['model', 'wizard'],
        help='The type of file you want to append.')

    # create sub parser for config action
    config_parser = subparsers.add_parser(
        'config', 
        help='Set and check the oerpmodule config')
    config_parser.add_argument(
        '-l', '--list-repositories', action='store_true',
        help='List the configurate repositories.')

    argcomplete.autocomplete(parser)
    return parser.parse_args()

def confirm_run(args):
    """
    Manual confirmation before runing the script. Very usefull.
    """
    print'\n... Configuration of Parameters Set'
    for (parameter, value) in args.__dict__.iteritems():
        print '%s = %s' % (parameter, value)

    confirm_flag = False
    while confirm_flag not in ['y', 'n']:
        confirm_flag = raw_input(
            'Confirm the run with the above parameters? [y/n]: ')
        if confirm_flag == 'y':
            print 'The script parameters were confirmed by the user'
        elif confirm_flag == 'n':
            print 'The user cancel the operation'
            exit()
        else:
            print 'The entry is not valid, please enter y or n.'
    return True

def main():

    config = oerp_module.Config()
    args = argument_parser(config)
    confirm_run(args)
  
    if args.action == 'config':
        args.list_repositories and config.print_repositories()
    else:
        module = oerp_module.Module(
            args.module_name, args.module_developers, args.module_planners,
            args.module_auditors, folder=args.destination_folder)

        if args.action == 'branch':
            branch = oerp_module.Branch(
                module, args.branch_suffix, args.parent_repo,
                args.oerp_version, args.destination_folder)
            branch.create_branch()
            module.update_path(branch)
            module.create_main_directory()
            module.create_directories()
            module.create_base_files()
        elif args.action == 'create':
            module.create_main_directory()
            module.create_directories()
            module.create_base_files()

        elif args.action == 'append':
            module.create_py_files(args.append_file)

        #~ module.branch_changes_apply()

if __name__ == '__main__':
    main()
